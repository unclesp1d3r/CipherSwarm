name: CI
permissions:
    contents: read

on:
    push:
        branches: [main]
    pull_request:
    workflow_dispatch:

jobs:
    test:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: cipherswarm
                    POSTGRES_PASSWORD: cipherswarm
                    POSTGRES_DB: cipherswarm
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Set up Python 3.13
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            - name: Set up Node.js
              uses: actions/setup-node@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4

            - name: Install just
              run: |
                  curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | sudo bash -s -- --to /usr/local/bin
                  just --version

            - name: Install uv
              run: |
                  curl -LsSf https://astral.sh/uv/install.sh | sh
                  echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

            - name: Verify uv installation
              run: uv --version

            - name: Wait for PostgreSQL
              run: |
                  echo "Waiting for PostgreSQL to be ready..."
                  sleep 10

            - name: Install dependencies
              run: uv sync --dev

            - name: Install frontend dependencies
              run: cd frontend && pnpm install

            - name: Install Playwright browsers
              run: cd frontend && pnpm exec playwright install --with-deps

            - name: Run CI checks
              env:
                  DATABASE_URL: postgresql://cipherswarm:cipherswarm@localhost:5432/cipherswarm
                  POSTGRES_HOST: localhost
                  POSTGRES_PORT: 5432
                  POSTGRES_USER: cipherswarm
                  POSTGRES_PASSWORD: cipherswarm
                  POSTGRES_DB: cipherswarm
                  # Legacy environment variables that might be used
                  POSTGRES_SERVER: localhost
                  DB_USER: cipherswarm
                  DB_PASSWORD: cipherswarm
                  DB_NAME: cipherswarm
                  DB_HOST: localhost
                  DB_PORT: 5432
              run: just ci-check

            - name: Upload coverage to Codecov
              if: success()
              uses: codecov/codecov-action@v4
              with:
                  file: ./coverage.xml
                  fail_ci_if_error: false
