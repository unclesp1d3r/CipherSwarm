<%# locals: (campaign:, attack:, failed_attack_error_map: nil) -%>
<%
  # Use provided error map or fall back to checking latest_agent_error
  has_error = if failed_attack_error_map
    failed_attack_error_map[attack.id].present?
  else
    attack.state == "failed" && attack.latest_agent_error.present?
  end
%>
<div id="attack-progress-<%= attack.id %>" class="d-flex flex-column gap-2 w-100">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
    <span class="fw-medium"><%= attack.to_label_with_complexity %></span>
    <div class="d-flex align-items-center gap-2">
      <% if attack.state == "failed" && has_error %>
        <button type="button"
                class="btn btn-sm btn-outline-danger"
                data-bs-toggle="modal"
                data-bs-target="#error-modal-attack-<%= attack.id %>"
                aria-label="<%= t("campaigns.attack_progress.view_error_details", name: attack.name) %>">
          <%= icon("exclamation-triangle-fill") %>
        </button>
      <% end %>
      <%= render Railsboot::ButtonGroupComponent.new(aria_label: t("campaigns.attack_progress.attack_actions", name: attack.name), size: "sm") do %>
        <% if safe_can? :read, attack %>
          <%= render Railsboot::Button::LinkComponent.new(href: campaign_attack_path(campaign, attack), aria_label: t("campaigns.attack_progress.view_attack")) do %>
            <%= icon("eye") %>
          <% end %>
        <% end %>
        <% if safe_can? :edit, attack %>
          <%= render Railsboot::Button::LinkComponent.new(href: edit_campaign_attack_path(campaign, attack), variant: "warning", aria_label: t("campaigns.attack_progress.edit_attack")) do %>
            <%= icon("pencil") %>
          <% end %>
        <% end %>
        <% if safe_can? :destroy, attack %>
          <%= render Railsboot::Button::LinkComponent.new(href: [campaign, attack], variant: "danger", method: :delete,
                                                          data: { turbo_method: :delete, turbo_confirm: t("campaigns.attack_progress.confirm_delete") },
                                                          aria_label: t("campaigns.attack_progress.delete_attack")) do %>
            <%= icon("trash-fill") %>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
  <%= render(CampaignProgressComponent.new(
    percentage: attack.percentage_complete,
    status: attack.state,
    eta: attack.estimated_finish_time,
    label: t("campaigns.attack_progress.attack_progress_label", name: attack.name)
  )) %>
</div>
