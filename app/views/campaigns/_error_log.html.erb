<%# locals: (campaign:, campaign_errors:, pagy:) -%>
<%= turbo_frame_tag "error_log" do %>
  <div class="card mb-3" id="campaign-error-log" role="region" aria-label="Campaign error log">
    <div class="card-header">
      <h5 class="mb-0 d-flex align-items-center gap-2">
        <%= icon("exclamation-circle") %>
        Campaign Error Log
      </h5>
    </div>
    <div class="card-body">
      <% if campaign_errors.blank? %>
        <%= render Railsboot::BlankSlateComponent.new do |blankslate| %>
          <% blankslate.with_icon do %>
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
              <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
          <% end %>
          <% blankslate.with_heading(tag: "h4").with_content("No Errors") %>
          <% blankslate.with_description.with_content("This campaign has no recorded errors.") %>
        <% end %>
      <% else %>
        <%= render Railsboot::TableComponent.new(responsive: true) do |table| %>
          <% table.with_head do %>
            <tr>
              <th scope="col">Severity</th>
              <th scope="col">Timestamp</th>
              <th scope="col">Message</th>
              <th scope="col">Attack</th>
              <th scope="col">Actions</th>
            </tr>
          <% end %>
          <% table.with_body do %>
            <% campaign_errors.each do |error| %>
              <tr>
                <td>
                  <span class="badge <%= severity_badge_class_for(error) %>">
                    <%= error.severity.humanize %>
                  </span>
                </td>
                <td><%= error.created_at.strftime("%b %d, %Y %I:%M %p") %></td>
                <td>
                  <span data-bs-toggle="tooltip" data-bs-title="<%= error.message %>" aria-label="Error message">
                    <%= truncate(error.message, length: 50) %>
                  </span>
                </td>
                <td>
                  <% if error.task&.attack.present? %>
                    <%= link_to "View Attack", campaign_attack_path(campaign, error.task.attack), class: "btn btn-sm btn-outline-primary" %>
                  <% else %>
                    <span class="text-muted">N/A</span>
                  <% end %>
                </td>
                <td>
                  <button type="button"
                          class="btn btn-sm btn-outline-secondary"
                          data-bs-toggle="modal"
                          data-bs-target="#error-modal-<%= error.id %>"
                          aria-label="View error details">
                    View Details
                  </button>
                </td>
              </tr>
            <% end %>
          <% end %>
        <% end %>

        <% if pagy.pages > 1 %>
          <div class="mt-3">
            <%== pagy.series_nav(:bootstrap) %>
            <noscript><%== pagy.series_nav %></noscript>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <%# Error Modals for Campaign Error Log %>
  <% campaign_errors&.each do |error| %>
    <%= render(ErrorModalComponent.new(
      error: error,
      modal_id: "error-modal-#{error.id}"
    )) %>
  <% end %>
<% end %>
