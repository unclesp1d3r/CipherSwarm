<h1><%= title "System Health" %></h1>

<% if @health_checks.present? %>
  <div class="row mb-4">
    <% @health_checks.each do |service_key, check| %>
      <div class="col-md-3 mb-3">
        <%= render SystemHealthCardComponent.new(
          service_name: service_name_for(service_key),
          status: check[:status],
          latency: check[:latency],
          error: check[:error]
        ) %>
      </div>
    <% end %>
  </div>

  <% sidekiq_check = @health_checks[:sidekiq] %>
  <% if sidekiq_check && sidekiq_check[:status] == :healthy %>
    <div class="row mb-4">
      <div class="col-12">
        <%= render Railsboot::CardComponent.new do |card| %>
          <% card.with_header do %>
            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Sidekiq Metrics</h5>
          <% end %>
          <% card.with_body do %>
            <div class="d-flex gap-4">
              <div>
                <strong>Workers:</strong> <%= sidekiq_check[:workers] %>
              </div>
              <div>
                <strong>Queues:</strong> <%= sidekiq_check[:queues] %>
              </div>
              <div>
                <strong>Enqueued Jobs:</strong> <%= sidekiq_check[:enqueued] %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="row mb-4">
    <div class="col-12">
      <%= render Railsboot::CardComponent.new do |card| %>
        <% card.with_header do %>
          <h5 class="mb-0"><i class="bi bi-tools"></i> Diagnostics</h5>
        <% end %>
        <% card.with_body do %>
          <ul class="list-unstyled mb-0">
            <% if can? :read, :admin_dashboard %>
              <li class="mb-2">
                <%= link_to sidekiq_web_path, class: "text-decoration-none" do %>
                  <i class="bi bi-speedometer2"></i> Sidekiq Dashboard
                <% end %>
              </li>
            <% end %>
            <li>
              <i class="bi bi-terminal"></i> Rails Logs <small class="text-muted">(view in terminal: <code>tail -f log/development.log</code>)</small>
            </li>
          </ul>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <%= link_to system_health_path, class: "btn btn-outline-secondary btn-sm" do %>
        <i class="bi bi-arrow-clockwise"></i> Refresh
      <% end %>
      <small class="text-muted ms-2">Results cached for 1 minute</small>
    </div>
  </div>
<% else %>
  <%= render Railsboot::BlankSlateComponent.new do %>
    <p class="mb-0">Unable to retrieve system health information. Please try again later.</p>
  <% end %>
<% end %>
