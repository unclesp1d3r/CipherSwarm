<%= render Railsboot::HeaderComponent.new do |header| %>
  <% header.with_heading do %>
    <%= title "Task ##{@task.id} - Status Logs" %>
  <% end %>
  <% header.with_breadcrumb.with_items([
       { text: "Dashboard", href: root_path },
       { text: "Activity", href: campaigns_path },
       { text: @task.attack.campaign.name, href: @task.attack.campaign },
       { text: @task.attack.name, href: campaign_attack_path(@task.attack.campaign, @task.attack) },
       { text: "Task ##{@task.id}", href: @task },
       { text: "Logs", href: logs_task_path(@task), active: true }
     ]) %>
<% end %>

<div class="row">
  <div class="col-12">
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Status History</h5>
        <%= link_to "Back to Task", @task, class: "btn btn-outline-secondary btn-sm" %>
      </div>
      <div class="card-body">
        <%= turbo_frame_tag "task_logs" do %>
          <% if @statuses.any? %>
            <div class="table-responsive">
              <table class="table table-sm table-hover mb-0">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Hash Rate</th>
                    <th>Estimated Stop</th>
                  </tr>
                </thead>
                <tbody>
                  <% @statuses.each do |status| %>
                    <tr>
                      <td>
                        <%= status.time.strftime("%Y-%m-%d %H:%M:%S") %>
                        <small class="text-muted d-block"><%= time_ago_in_words(status.time) %> ago</small>
                      </td>
                      <td>
                        <span class="badge <%= status_badge_class(status.status) %>">
                          <%= status.status.humanize %>
                        </span>
                      </td>
                      <td>
                        <% if status.progress.present? && status.progress.is_a?(Array) && status.progress.length >= 2 %>
                          <%= number_to_percentage(status.progress_percentage, precision: 2) %>
                          <small class="text-muted d-block">
                            <%= number_with_delimiter(status.progress[0]) %> / <%= number_with_delimiter(status.progress[1]) %>
                          </small>
                        <% else %>
                          N/A
                        <% end %>
                      </td>
                      <td>
                        <%= number_to_human(status.device_speed, units: { unit: "H/s", thousand: "KH/s", million: "MH/s", billion: "GH/s" }) %>
                      </td>
                      <td>
                        <% if status.estimated_stop.present? %>
                          <%= status.estimated_stop.strftime("%Y-%m-%d %H:%M:%S") %>
                          <small class="text-muted d-block">
                            <% if status.estimated_stop > Time.current %>
                              in <%= time_ago_in_words(status.estimated_stop) %>
                            <% else %>
                              <%= time_ago_in_words(status.estimated_stop) %> ago
                            <% end %>
                          </small>
                        <% else %>
                          N/A
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>

            <nav class="mt-3" aria-label="Status history pagination">
              <%== @pagy.series_nav if @pagy.pages > 1 %>
            </nav>
          <% else %>
            <p class="text-muted mb-0">No status history available for this task.</p>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
